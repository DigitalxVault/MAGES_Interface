---
phase: 03-background-music
plan: 01
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - src/components/BackgroundMusic.tsx
  - src/stores/appStore.ts
  - src/components/MainInterface.tsx
  - public/sounds/background/.gitkeep
autonomous: true

must_haves:
  truths:
    - "User can select track from dropdown populated with available music files"
    - "Play/pause/stop controls work as expected"
    - "Progress bar shows current position during playback"
    - "Track loops seamlessly back to start when reaching end"
    - "Volume slider adjusts background music independently"
  artifacts:
    - path: "src/components/BackgroundMusic.tsx"
      provides: "Background music player with transport controls"
      exports: ["BackgroundMusic"]
    - path: "src/stores/appStore.ts"
      provides: "Music playback state with localStorage persistence"
      exports: ["useAppStore"]
  key_links:
    - from: "src/components/BackgroundMusic.tsx"
      to: "use-sound"
      via: "useSound hook with loop option"
      pattern: "useSound\\("
    - from: "src/components/BackgroundMusic.tsx"
      to: "src/stores/appStore.ts"
      via: "useAppStore hook"
      pattern: "useAppStore\\(\\)"
---

<objective>
Create background music player with transport controls and progress tracking

Purpose: Provide ambient background music during board game sessions with independent volume control from sound effects. Track loops seamlessly for continuous atmosphere.

Output: Working music player with track selection, transport controls, progress bar, looping, and volume control
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-sound-effects/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add music playback state to store</name>
  <files>
    src/stores/appStore.ts
  </files>
  <action>
    Update src/stores/appStore.ts:
    - Add musicPlayback state interface:
      - isPlaying: boolean (default false)
      - currentTrack: string (default empty)
      - progress: number (0-1, default 0)
      - duration: number (in seconds, default 0)
    - Add actions:
      - setMusicPlaying(playing: boolean)
      - setCurrentTrack(track: string)
      - setMusicProgress(progress: number)
      - setMusicDuration(duration: number)
    - Note: Don't persist playback state (only volume preferences)
      - Playing state should reset on page load
  </action>
  <verify>
    TypeScript compiles without errors
    New state properties added
    New actions added
    Playback state NOT persisted (only volume)
  </verify>
  <done>
    Music playback state added to store
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BackgroundMusic component</name>
  <files>
    src/components/BackgroundMusic.tsx
  </files>
  <action>
    Create src/components/BackgroundMusic.tsx:
    - 'use client' directive
    - Import useSound with loop: true option for seamless looping
    - Import useAppStore for state management
    - Import MetalPanel, RivetButton
    - Track dropdown with available files:
      - Ambient Loop.mp3
      - Battle Theme.mp3
      - Mystery.mp3
      - Tavern.mp3
      - Dungeon.mp3
    - Transport controls row:
      - Play button (shows Pause when playing)
      - Stop button (resets to start)
    - Progress bar:
      - Range input 0-100
      - Updates during playback (use sound.position() callback)
      - Clickable to seek
    - Volume slider:
      - Connected to musicVolume from store
      - Independent from effects volume
    - Display current time / total time
    - Use Howl options: { loop: true, volume: musicVolume, html5: false } for better loop support
  </action>
  <verify>
    BackgroundMusic renders with all controls
    Track dropdown shows available files
    Play/pause/stop buttons work
    Volume slider independent from effects
    Progress bar updates during playback
  </verify>
  <done>
    BackgroundMusic component created
  </done>
</task>

<task type="auto">
  <name>Task 3: Create placeholder music folder</name>
  <files>
    public/sounds/background/.gitkeep
  </files>
  <action>
    Create public/sounds/background/.gitkeep:
    - Empty file to ensure folder is tracked by git
    - Folder will be populated with actual audio files
    - Include README.md with format guidance
  </action>
  <verify>
    Folder structure exists
  </verify>
  <done>
    Placeholder music folder created
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate BackgroundMusic into MainInterface</name>
  <files>
    src/components/MainInterface.tsx
  </files>
  <action>
    Update src/components/MainInterface.tsx:
    - Import BackgroundMusic
    - Replace the "BACKGROUND MUSIC" placeholder panel
    - Use BackgroundMusic component
    - Keep DICE and TIMER panels as placeholders
  </action>
  <verify>
    MainInterface shows BackgroundMusic in place of placeholder
    Other 2 panels remain as "Coming soon..."
  </verify>
  <done>
    BackgroundMusic integrated into main interface
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. MainInterface shows BackgroundMusic panel
2. Track dropdown displays available music files
3. Selecting a track loads it for playback
4. Play button starts playback, changes to Pause
5. Pause button pauses playback, changes back to Play
6. Stop button resets playback to beginning
7. Progress bar updates during playback
8. Progress bar is clickable to seek
9. Track loops seamlessly when reaching end
10. Volume slider controls music independently (70% default)
11. Current/total time displays correctly
12. Page refresh resets playback state (volume persists)
</verification>

<success_criteria>
- Track selection dropdown works
- Play/pause/stop controls functional
- Progress bar tracks position
- Seamless looping enabled
- Independent volume control
- Time display shows position/duration
- Industrial styling matches design system
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-music/03-01-SUMMARY.md`
</output>
